<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCJPen</title>
    <link rel="icon" type="image/png" sizes="32x32"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAdpJREFUaIHlmm1uwzAIhiHaJdp7ZfdIpfYQmZTeI71j2Z9Z8rzYBgOOrL2/2jTBmMfgjxThR0SEt8frDQNoW+cJEQkAYAIAIKLLKM4DANwerzcRXQAAcKTIp9rWecLlvtPZjmg0ne2AVsN34MPL8PPr89f35b67tONCIHU+d81CpgRqTobfLWmYEZBE2JKGmkBprB9FPFyzoqEi0JKo6T1aGk0EtBUm3G9BQ0zAsjxa0GAT8KrrWhosAj0mpVYaRQK9ZtPUvoRGlkBv50ttlWi4rIXSBj1m4KBDApq1TOk+jY3cs6IyWnPuaNgdDQeLTgZVhxAnsWr5ktoInzk2ah1i58By3/84kLvP00YqURKXosJt1MJGrP+1peQkXy2KFjZisQnkKoxk0rGwkerwXKhkoBQdbiWR2Kg9J8qBGlpOzZfaqCl7MqddC/V63q0KxQ16LgSzHZAuAawkHXZFAtoKIRVnLZWKNYS8abQkexA7B7xotEQ9ljiJrWhooh6rqQppaWijHktVRls2K9Z7bbNXTNJhZDU3mE1kEocsJzbTU4naNrDbqYRWR456LSfc3pH1Oggbfks5fge2dR62E9s6TxMi0rbO17OdkWpb5ysiEoYLI/3pI/67zTedx0h7KK4XJQAAAABJRU5ErkJggg==">
    <link rel="stylesheet" href="./assets/style.css">
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="./assets/vs/editor/editor.main.css">
</head>

<body>
    <header>
        <div class="menu">
            <button class="run">Run</button>
            <button class="download">Download</button>
            <a class=fullpageLink href="./iframe.html" target="_blank" rel="noopener noreferrer">
                <button class="fullpage">Fullpage</button>
            </a>
        </div>

        <h1><span style="color: var(--HTML-color)">H</span><span style="color: var(--CSS-color)">C</span><span style="color: var(--JS-color)">J</span>-Pen</h1>
        <div>&nbsp;</div>
    </header>
    <main>


        <!-- LEFT SIDE -->
        <div class="codeBoxes">
            <!-- HTML -->
            <div class="HTMLbox codeBox">
                <div class="header">HTML
                    <label class="cbWrapper">
                        <input id="cbhtml" type="checkbox" checked="checked" style="display: none;">
                        <label for="cbhtml" title="instant reload"></label>
                    </label>
                </div>
                <div class="editor"> </div>
            </div>

            <!-- CSS -->
            <div class="CSSbox codeBox">
                <div class="header resize">CSS
                    <label class="cbWrapper">
                        <input id="cbcss" type="checkbox" checked="checked" style="display: none;">
                        <label for="cbcss" title="instant reload"></label>
                    </label>
                </div>
                <div class="editor"></div>
            </div>

            <!-- JS -->
            <div class="JSbox codeBox">
                <div class="header resize">JS
                    <label class="cbWrapper">
                        <input id="cbjs" type="checkbox" style="display: none;">
                        <label for="cbjs" title="instant reload"></label>
                    </label>
                </div>
                <div class="editor"> </div>
            </div>

        </div>

        <!-- RIGHT SIDE -->
        <div class="divider">&nbsp;</div>
        <div class="resultBox">
            <iframe id=resultIframe src="./iframe.html" frameborder="0"></iframe>
        </div>



    </main>
    <footer>
        <div class="withLove">
            <a href="https://github.com/KoljaL/HCJPen" title="Link to Github Repository" target="_blank">
                Made with
                <svg viewBox="0 0 1792 1792" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#8E1B1B" d="M896 1664q-26 0-44-18l-624-602q-10-8-27.5-26T145 952.5 77 855 23.5 734 0 596q0-220 127-344t351-124q62 0 126.5 21.5t120 58T820 276t76 68q36-36 76-68t95.5-68.5 120-58T1314 128q224 0 351 124t127 344q0 221-229 450l-623 600q-18 18-44 18z"></path>
                </svg>
                by
                <img src="https://rasal.de/img/HCJP-15.png" alt="HCJP" width="15px">
            </a>
        </div>
    </footer>
</body>
<script src="./assets/main.js"></script>
<!-- <script>var require = {paths: {'vs': 'assets/vs'}};</script> -->


<script>
    // https://dev.to/pulljosh/how-to-load-html-css-and-js-code-into-an-iframe-2blc
    var editor = {};
    var data = {};
    var html, css, js;
    let filename = 'HCJPen';
    var iframe = select('.resultBox iframe');
    const runButton = select('header .run');
    const fullpageLink = select('header .fullpageLink');
    const downloadButton = select('header .download');
    window.onload = function () {
        loadFileContent('default');
    };




    /**
     * 
     * eventListener
     * 
     */
    runButton.addEventListener('click', () => {createIframe(data)})
    downloadButton.addEventListener('click', () => {downloadAsFile(data, true)})


    /**
     * 
     * download html file
     * 
     */
    function downloadAsFile() {
        downloadString(html_string, "text/csv", "index.html")
        function downloadString(text, fileType, fileName) {
            var blob = new Blob([text], {type: fileType});
            var a = document.createElement('a');
            a.download = fileName;
            a.href = URL.createObjectURL(blob);
            a.dataset.downloadurl = [fileType, a.download, a.href].join(':');
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(function () {URL.revokeObjectURL(a.href);}, 1500);
        }
    }








    /**
     * 
     * detect changes in editors and reload the iframe (if checkbox)
     * 
     */
    function reloadIframeOnChange() {
        editor['html'].getModel().onDidChangeContent((event) => {
            runButton.classList.add('change');
            if (select('#cbhtml').checked) {
                createIframe(data)
            };
        })


        editor['css'].getModel().onDidChangeContent((event) => {
            runButton.classList.add('change');
            if (select('#cbcss').checked) {
                createIframe(data)
            }
        });


        editor['javascript'].getModel().onDidChangeContent((event) => {
            runButton.classList.add('change');
            if (select('#cbjs').checked) {
                createIframe(data)
            }
        });
    }




    /**
     * 
     * create iframe and load all content to it
     * 
     */
    function createIframe(data) {
        // get values (content) from editors
        data[0] = editor['html'].getValue();
        data[1] = editor['css'].getValue();
        data[2] = editor['javascript'].getValue();

        // save to localStorage & reload iframe
        localStorage.setItem(filename, JSON.stringify(data));
        iframe.src = 'iframe.html?console&file=' + filename

        // add filename to fullpage link
        fullpageLink.href = 'iframe.html?file=' + filename

        // reset bitton boarder
        runButton.classList.remove('change');
    }



    /**
     * 
     * load three file contents & load it to the editor
     * 
     */
    function loadFileContent(file) {
        fetch(`./code/${file}/${file}.json`)
            .then((res) => res.json())
            .then((data) => {
                // console.log(data);
                loadEditor(select(".HTMLbox .editor"), data.html, 'html');
                loadEditor(select(".CSSbox .editor"), data.css, 'css');
                loadEditor(select(".JSbox .editor"), data.js, 'javascript');
                return data
            })
            .then((data) =>
                setTimeout(() => {
                    createIframe(data);
                    reloadIframeOnChange();
                }, 1000)
            );
    }



    /**
     * 
     * load monaco editor
     * 
     */
    var require = {paths: {'vs': 'assets/vs'}};
    function loadEditor(element, fileContent, lang) {

        monaco.editor.defineTheme('OneDark', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                {token: 'comment', foreground: '#7f848e'},
                {token: 'attribute.value.html', foreground: '#98C379'},
                {token: 'attribute.name.html', foreground: '#D19A66'},
                {token: 'tag.html', foreground: '#E06C75'},
                {token: 'tag.css', foreground: '#D19A66'},

            ],
            colors: {
                "editor.background": "#151515",
            }
        });


        editor[lang] = monaco.editor.create(element, {
            value: fileContent,
            language: lang,
            lineNumbers: "on",
            roundedSelection: true,
            scrollBeyondLastLine: true,
            readOnly: false,
            formatOnPaste: true,
            formatOnType: true,
            minimap: {
                enabled: false
            },
            automaticLayout: true,
            contextmenu: true,
            fontSize: 14,
            scrollbar: {
                useShadows: false,
                vertical: "hidden",
                horizontal: "visible",
                horizontalScrollbarSize: 12,
                verticalScrollbarSize: 0
            },
            theme: 'OneDark',
        });


    }


    // read all items in locasStorage
    // for (var i = 0; i < localStorage.length; i++) {
    //     var key = localStorage.key(i);
    //     var value = localStorage.getItem(key);
    //     // console.log('Key: ' + key + ', Value: ' + value);
    // }


</script>
<script src="assets/vs/loader.js"></script>
<script src="assets/vs/editor/editor.main.nls.js"></script>
<script src="assets/vs/editor/editor.main.js"></script>

</html>